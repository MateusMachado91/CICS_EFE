@page "/"
@using Microsoft.EntityFrameworkCore.Metadata.Internal
@using PYBWeb.Domain.Entities
@using PYBWeb.Domain.Interfaces
@using PYBWeb.Web.Models
@using PYBWeb.Infrastructure.Services
@using System.Text
@using Microsoft.AspNetCore.Authorization
@using PYBWeb.Infrastructure.Mainframe
@inject IAmbienteCicsService AmbienteCicsService
@inject IAmbienteTodosService AmbienteTodosService
@inject NavigationManager Navigation
@inject ISolicitacoesCics2025Service SolicitacoesCics2025Service
@inject ILogService LogService
@inject IJSRuntime JSRuntime
@inject IJclGeneratorService JclGenerator
@inject ICurrentUserService CurrentUserService
@rendermode InteractiveServer

@attribute [Authorize(Policy = "RequireAdmin")]

<PageTitle>Implementa√ß√µes - PYB CICS</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="display-6 text-primary">
                <i class="bi bi-code-slash"></i> Implementa√ß√µes CICS
            </h1>
            @if (solicitacoesSelecionadas.Any())
            {
                <small class="text-muted">
                    @solicitacoesSelecionadas.Count solicita√ß√£o(√µes) selecionada(s)
                </small>
            }
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-success btn-lg me-2" 
                    @onclick="AbrirTelaImplementacao" 
                    disabled="@(! PodVisualizarJcl)">
                <i class="bi bi-code-slash"></i> Visualizar JCL (@solicitacoesSelecionadas.Count)
            </button>
            <button class="btn btn-danger btn-lg" 
                    @onclick="AbrirModalRecusa" 
                    disabled="@(!solicitacoesSelecionadas. Any())">
                <i class="bi bi-x-circle"></i> Recusar
            </button>
        </div>
    </div>

    @if (! exibirTelaCobol)
    {
        @if (isLoading)
        {
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
            </div>
        }
        else
        {
            @if (! string.IsNullOrWhiteSpace(mensagemErroCompatibilidade))
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>Incompatibilidade detectada!</strong>
                    <p class="mb-0 mt-2">@mensagemErroCompatibilidade</p>
                    <button type="button" class="btn-close" @onclick="() => mensagemErroCompatibilidade = string.Empty"></button>
                </div>
            }

            <div class="alert alert-info mb-4">
                <i class="bi bi-info-circle"></i> 
                Clique nas linhas para selecionar uma ou mais solicita√ß√µes pendentes para implementar.
                <strong>Aten√ß√£o:</strong> Solicita√ß√µes devem ser da mesma <strong>M√°quina</strong>. 
            </div>

            <div class="card">
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th >Sel. </th>
                                <th>Status</th>
                                <th>Tipo</th>
                                <th>Opera√ß√£o</th>
                                <th>Solicitante</th>
                                <th>Data</th>
                                <th>Ambiente</th>
                                <th>CSS</th>
                                <th>M√°quina</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var grupo in solicitacoesAgrupadas.OrderBy(g => g.Key))
                            {
                                @foreach (var solicitacao in grupo.Value)
                                {
                                    var ambiente = ambientes.FirstOrDefault(a => a.Nome == solicitacao.Appli);
                                    var estaSelecionada = solicitacoesSelecionadas.Any(s => s.Id == solicitacao.Id);

                                    <tr class="@(estaSelecionada ? "table-primary" : "")" 
                                        style="cursor: pointer;"
                                        @onclick="() => SelecionarSolicitacao(solicitacao)">
                                        
                                        @* ‚úÖ √çCONE em vez de checkbox *@
                                        <td class="text-center">
                                            @if (estaSelecionada)
                                            {
                                                <i class="bi bi-check-circle-fill text-primary fs-5"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-circle text-muted"></i>
                                            }
                                        </td>
                                        
                                        <td>
                                            @if (solicitacao.Status == "Pendente")
                                            {
                                                <span class="badge bg-warning">Pendente</span>
                                            }
                                            else if (solicitacao.Status == "Em An√°lise")
                                            {
                                                <span class="badge bg-info">Em An√°lise</span>
                                            }
                                        </td>
                                        <td><span class="badge bg-secondary">@solicitacao.TipoTabela @solicitacao.Type</span></td>
                                        <td>
                                            <span class="badge @GetBadgeClassOperacao(solicitacao.Operacao ??  string.Empty)">
                                                @solicitacao.Operacao
                                            </span>    
                                        </td>
                                        <td>@solicitacao.Usuario</td>
                                        <td>@solicitacao.DataSolicitacao.ToString("dd/MM/yyyy")</td>
                                        <td>
                                                @solicitacao.Appli
                                        </td>
                                        <td><span class="badge bg-info">@solicitacao.Css</span></td>
                                        <td>
                                            @if (ambiente != null)
                                            {
                                                <span class="badge bg-dark">@ambiente.Maquina @ambiente.Sufixo</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            @if (!solicitacoesAgrupadas.Any())
            {
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> Nenhuma solicita√ß√£o pendente encontrada.
                </div>
            }
        }
    }
    else
    {
        <div class="card border-dark">
            <div class="card-header bg-dark text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-terminal"></i>
                        <strong>@solicitacoesSelecionadas.Count</strong> solicita√ß√£o(√µes) - 
                        Ambiente: <strong>@ObterAmbienteDisplay()</strong>
                    </h5>
                    <button class="btn btn-sm btn-outline-light" @onclick="VoltarParaLista">
                        <i class="bi bi-arrow-left"></i> Voltar
                    </button>
                </div>
            </div>

            @* ‚≠ê √ÅREA DE JUSTIFICATIVAS *@
            @if (ExisteJustificativa())
            {
                <div class="alert alert-warning mb-0" style="border-radius: 0;">
                    <h6 class="alert-heading">
                        <i class="bi bi-exclamation-triangle-fill"></i> Justificativas
                    </h6>
                    <hr/>
                    @foreach (var sol in solicitacoesSelecionadas.Where(s => 
                        ! string.IsNullOrWhiteSpace(s.JustificativaAutoAlt) || 
                        !string.IsNullOrWhiteSpace(s.JustificativaBelow)))
                    {
                        <div class="mb-3">
                            <strong>Solicita√ß√£o @sol.NumeroSolicitacao:</strong>
                            @if (!string.IsNullOrWhiteSpace(sol.JustificativaAutoAlt))
                            {
                                <p class="mb-1"><strong>Auto Alter√°vel:</strong> @sol.JustificativaAutoAlt</p>
                            }
                            @if (!string.IsNullOrWhiteSpace(sol.JustificativaBelow))
                            {
                                <p class="mb-0"><strong>Below:</strong> @sol.JustificativaBelow</p>
                            }
                        </div>
                    }
                </div>
            }

            <div class="card-body bg-black p-1">
                @* Resumo das solicita√ß√µes selecionadas *@
                @if (solicitacoesSelecionadas.Count > 1)
                {
                    <div class="alert alert-info mb-2">
                        <strong>Solicita√ß√µes selecionadas (@solicitacoesSelecionadas.Count):</strong>
                        <ul style="margin-bottom: 4px;">
                            @foreach (var sol in solicitacoesSelecionadas)
                            {
                                <li>
                                    <strong>@sol.TipoTabela</strong> - <strong>@sol.Operacao</strong>
                                    @if (! string.IsNullOrEmpty(sol.NameArq)) { <span>‚Äî @sol.NameArq</span> }
                                    @if (!string.IsNullOrEmpty(sol.NameTrans)) { <span>‚Äî @sol.NameTrans</span> }
                                    @if (! string.IsNullOrEmpty(sol.NameSoft)) { <span>‚Äî @sol.NameSoft</span> }
                                    (@sol.NumeroSolicitacao)
                                </li>
                            }
                        </ul>
                    </div>
                }

                <textarea @bind="jclGerado" 
                          @bind:event="oninput"
                          class="form-control border-0" 
                          rows="30"
                          style="background-color: #000000; 
                                 color: #e6e333; 
                                 font-family: 'Courier New', monospace; 
                                 font-size: 16px; 
                                 resize: vertical;
                                 outline: none;
                                 box-shadow: none;"
                          placeholder="O JCL gerado aparecer√° aqui e poder√° ser editado... "></textarea>
            </div>

            <div class="card-footer bg-dark">
                <div class="d-flex gap-2 justify-content-between align-items-center">
                    <strong style="color: #ffffff;">
                        @solicitacoesSelecionadas.Count solicita√ß√£o(√µes) selecionada(s)
                    </strong>
                    <div>
                        <button class="btn btn-success" @onclick="SubmeterJCLAsync">
                            <i class="bi bi-file-earmark-code"></i> Submeter JCL
                        </button>
                        <button class="btn btn-danger" @onclick="AbrirModalRecusa">
                            <i class="bi bi-x-circle"></i> Recusar
                        </button>
                        <button class="btn btn-secondary" @onclick="VoltarParaLista">
                            <i class="bi bi-x-circle"></i> Fechar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@* Modal de Recusa (mant√©m o mesmo) *@
@if (exibirModalRecusa)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle"></i> Recusar Solicita√ß√£o(√µes)
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="FecharModalRecusa"></button>
                </div>
                <div class="modal-body">
                    <p><strong>@solicitacoesSelecionadas.Count solicita√ß√£o(√µes) selecionada(s)</strong></p>
                    <ul>
                        @foreach (var sol in solicitacoesSelecionadas)
                        {
                            <li>@sol.NumeroSolicitacao - @sol.TipoTabela - @sol.Operacao</li>
                        }
                    </ul>
                    <hr/>
                    <div class="mb-3">
                        <label for="motivoRecusa" class="form-label"><strong>Motivo da Recusa:</strong> <span class="text-danger">*</span></label>
                        <textarea id="motivoRecusa" 
                                  class="form-control" 
                                  rows="4" 
                                  @bind="motivoRecusa"
                                  placeholder="Descreva o motivo da recusa... "></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="FecharModalRecusa">Cancelar</button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmarRecusaAsync" disabled="@string.IsNullOrWhiteSpace(motivoRecusa)">
                        <i class="bi bi-check-circle"></i> Confirmar Recusa
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // ‚≠ê MODO DEBUG
    private readonly bool DEBUG_MODE = true;
    private string usuarioAtual = string.Empty;

    // ‚úÖ Lista de selecionadas
    private List<SolicitacaoCics2025> solicitacoesSelecionadas = new();
    private string mensagemErroCompatibilidade = string.Empty;
    private bool PodVisualizarJcl => solicitacoesSelecionadas != null && solicitacoesSelecionadas.Any();
    
    private IEnumerable<AmbienteCics> ambientes = new List<AmbienteCics>();
    private bool isLoading = true;
    private bool exibirTelaCobol = false;
    private string jclGerado = "";
    private List<SolicitacaoCics2025> solicitacoesAprovadas = new();
    private Dictionary<string, List<SolicitacaoCics2025>> solicitacoesAgrupadas = new();
    
    // Modal de Recusa
    private bool exibirModalRecusa = false;
    private string motivoRecusa = "";

protected override async Task OnInitializedAsync()
    {
        // ‚úÖ CAPTURA O USU√ÅRIO COM FALLBACK
        usuarioAtual = CurrentUserService.UserName;
        
        // ‚úÖ SE AINDA ESTIVER VAZIO, TENTA DE NOVO
        if (string.IsNullOrWhiteSpace(usuarioAtual))
        {
            Console.WriteLine("[INIT] Usu√°rio vazio, tentando novamente...");
            await Task.Delay(100); // Pequeno delay
            usuarioAtual = CurrentUserService.UserName;
        }
        
        // ‚úÖ SE AINDA ESTIVER VAZIO, USA UM PADR√ÉO
        if (string.IsNullOrWhiteSpace(usuarioAtual))
        {
            Console.WriteLine("[INIT] Usu√°rio ainda vazio, usando 'SISTEMA'");
            usuarioAtual = "SISTEMA";
        }
        
        Console.WriteLine($"[INIT] Usu√°rio capturado: '{usuarioAtual}'");
        
        ambientes = await AmbienteCicsService.ObterAmbientesAtivosAsync();
        await CarregarSolicitacoesPendentes();
    }

    private async Task CarregarSolicitacoesPendentes()
    {
        isLoading = true;
        try
        {
            var pendentes = await SolicitacoesCics2025Service.ObterSolicitacoesPorStatusAsync("Pendente");
            var emAnalise = await SolicitacoesCics2025Service.ObterSolicitacoesPorStatusAsync("Em An√°lise");
            
            solicitacoesAprovadas = pendentes.Concat(emAnalise).ToList();
            
            solicitacoesAgrupadas = solicitacoesAprovadas
                .GroupBy(s => s.TipoTabela ??  "Outros")
                .ToDictionary(g => g.Key, g => g.ToList());
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao carregar solicita√ß√µes:  {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    
    // ‚úÖ Valida√ß√£o de compatibilidade (apenas M√ÅQUINA)
    private bool ValidarCompatibilidadeAmbiente(SolicitacaoCics2025 novaSolicitacao)
    {
        if (! solicitacoesSelecionadas. Any()) return true;

        var ambienteReferencia = ambientes.FirstOrDefault(a => a.Id == solicitacoesSelecionadas. First().AmbienteId);
        var ambienteNovo = ambientes.FirstOrDefault(a => a.Id == novaSolicitacao.AmbienteId);

        if (ambienteReferencia == null || ambienteNovo == null)
        {
            mensagemErroCompatibilidade = "Ambiente n√£o encontrado. ";
            return false;
        }

        // Valida√ß√£o:  Apenas M√ÅQUINA deve ser igual
        if (ambienteReferencia. Maquina != ambienteNovo.Maquina)
        {
            mensagemErroCompatibilidade = $"Incompat√≠vel!  M√°quina selecionada: {ambienteReferencia.Maquina}. " +
                                          $"Nova solicita√ß√£o: {ambienteNovo.Maquina}.  " +
                                          $"Todas as solicita√ß√µes devem ser da mesma M√°quina.";
            return false;
        }

        mensagemErroCompatibilidade = string.Empty;
        return true;
    }

    // ‚úÖ Gerar JCL para m√∫ltiplas solicita√ß√µes
    private void AbrirTelaImplementacao()
    {
        if (! solicitacoesSelecionadas.Any()) return;

        var ambiente = ambientes.FirstOrDefault(a => a.Id == solicitacoesSelecionadas.First().AmbienteId);
        if (ambiente == null) return;

        jclGerado = JclGenerator.GerarJclGrupo(solicitacoesSelecionadas, ambiente);

        exibirTelaCobol = true;
        StateHasChanged();
    }

    private void VoltarParaLista()
    {
        exibirTelaCobol = false;
        jclGerado = "";
        StateHasChanged();
    }

    private string ObterAmbienteDisplay()
    {
        if (! solicitacoesSelecionadas. Any()) return "";
        
        var ambiente = ambientes.FirstOrDefault(a => a.Id == solicitacoesSelecionadas.First().AmbienteId);
        return ambiente != null ? $"{ambiente.IdChave} ({ambiente.Maquina}{ambiente.Sufixo})" : "N/A";
    }

    // ========== MODAL DE RECUSA ==========
    private void AbrirModalRecusa()
    {
        if (!solicitacoesSelecionadas. Any()) return;
        motivoRecusa = "";
        exibirModalRecusa = true;
        StateHasChanged();
    }

    private void FecharModalRecusa()
    {
        exibirModalRecusa = false;
        motivoRecusa = "";
        StateHasChanged();
    }

    
    // ========== SUBMISS√ÉO DE JCL ==========
    

private async Task SubmeterJCLAsync()
    {
        // ‚úÖ USA O USU√ÅRIO J√Å ARMAZENADO NO COMPONENTE
        Console.WriteLine($"[SUBMETER] Usando usu√°rio: '{usuarioAtual}'");
        
        if (!solicitacoesSelecionadas.Any()) return;

        var ambiente = ambientes.FirstOrDefault(a => a.Id == solicitacoesSelecionadas.First().AmbienteId);
        if (ambiente == null) return;

        string conteudoJcl = !string.IsNullOrWhiteSpace(jclGerado) 
            ? jclGerado 
            : JclGenerator.GerarJclGrupo(solicitacoesSelecionadas, ambiente);

        var pastaBase = Path.Combine(AppContext.BaseDirectory, "..", "DATA_PYB");
        var pastaJcl = Path.Combine(pastaBase, "JCL");
        if (!Directory.Exists(pastaJcl))
            Directory.CreateDirectory(pastaJcl);

        var nomeArquivo = $"{ambiente.Maquina}{ambiente.Sufixo}{DateTime.Now:HHmmss}.jcl";
        var caminhoCompleto = Path.Combine(pastaJcl, nomeArquivo);
        
        File.WriteAllText(caminhoCompleto, conteudoJcl);

        var caminhoRelativo = caminhoCompleto.Substring(pastaJcl.Length);
        if (!caminhoRelativo.StartsWith("\\"))
            caminhoRelativo = "\\" + caminhoRelativo;

        bool sucesso;
        string mensagemJes;
        string codigoRetorno;
        string numeroJob;

        if (DEBUG_MODE)
        {
            sucesso = true;
            mensagemJes = "üîß [MODO DEBUG] JCL N√ÉO foi submetido ao mainframe";
            codigoRetorno = "DEBUG-OK";
            numeroJob = $"DEBUG{DateTime.Now:HHmmss}";

            Console.WriteLine("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
            Console.WriteLine("‚ïë           üîß MODO DEBUG - MAINFRAME DESABILITADO          ‚ïë");
            Console.WriteLine("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£");
            Console.WriteLine($"‚ïë Arquivo JCL: {nomeArquivo,-42} ‚ïë");
            Console.WriteLine($"‚ïë Solicita√ß√µes:  {solicitacoesSelecionadas.Count,-40} ‚ïë");
            Console.WriteLine($"‚ïë Usu√°rio: {usuarioAtual,-48} ‚ïë");
            Console.WriteLine("‚ïë ‚úÖ JCL gerado e salvo com sucesso!                         ‚ïë");
            Console.WriteLine("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
        }
        else
        {
            (sucesso, mensagemJes, codigoRetorno, numeroJob) = JesSubmitter.SubmeterJCL(caminhoCompleto);
        }

        // ‚úÖ USA O USU√ÅRIO ARMAZENADO
        foreach (var item in solicitacoesSelecionadas)
        {
            await AlterarStatusComLog(
                item.Id,
                "Implementada",
                DEBUG_MODE 
                    ? $"[DEBUG] JCL: {caminhoRelativo} | JOB: {numeroJob} | Status: {codigoRetorno}"
                    : $"JCL: {caminhoRelativo} | JOB: {numeroJob} | Status: {codigoRetorno}",
                null,
                usuarioAtual // ‚úÖ PASSA O USU√ÅRIO ARMAZENADO
            );
        }

        var mensagemCompleta = DEBUG_MODE
            ? $"üîß MODO DEBUG\n\nArquivo: {nomeArquivo}\nSolicita√ß√µes: {solicitacoesSelecionadas.Count}\nUsu√°rio: {usuarioAtual}"
            : $"{mensagemJes}\n\nArquivo: {nomeArquivo}\nSolicita√ß√µes: {solicitacoesSelecionadas.Count}";

        await JSRuntime.InvokeVoidAsync("alert", mensagemCompleta);

        await CarregarSolicitacoesPendentes();
        VoltarParaLista();
        solicitacoesSelecionadas.Clear();
        StateHasChanged();
    }

        private async Task SelecionarSolicitacao(SolicitacaoCics2025 solicitacao)
    {
        var jaSelecionada = solicitacoesSelecionadas.Any(s => s.Id == solicitacao.Id);

        if (jaSelecionada)
        {
            solicitacoesSelecionadas.RemoveAll(s => s.Id == solicitacao.Id);
            StateHasChanged();
            await CarregarSolicitacoesPendentes();
            StateHasChanged();
            return;
        }

        if (solicitacoesSelecionadas.Any())
        {
            if (!ValidarCompatibilidadeAmbiente(solicitacao))
            {
                StateHasChanged();
                return;
            }
        }

        solicitacoesSelecionadas.Add(solicitacao);
        
        if (solicitacao.Status == "Pendente")
        {
            // ‚úÖ USA O USU√ÅRIO ARMAZENADO
            await AlterarStatusComLog(
                solicitacao.Id, 
                "Em An√°lise", 
                "Solicita√ß√£o selecionada para an√°lise",
                null,
                usuarioAtual // ‚úÖ PASSA O USU√ÅRIO ARMAZENADO
            );
        }

        StateHasChanged();
        await CarregarSolicitacoesPendentes();
        StateHasChanged();
    }
    private async Task ConfirmarRecusaAsync()
    {
        if (!solicitacoesSelecionadas.Any() || string.IsNullOrWhiteSpace(motivoRecusa)) return;

        try
        {
            foreach (var sol in solicitacoesSelecionadas)
            {
                // ‚úÖ USA O USU√ÅRIO ARMAZENADO
                await AlterarStatusComLog(
                    sol.Id, 
                    "Rejeitada", 
                    $"Solicita√ß√£o rejeitada. Motivo: {motivoRecusa}",
                    motivoRecusa,
                    usuarioAtual // ‚úÖ PASSA O USU√ÅRIO ARMAZENADO
                );
            }

            await JSRuntime.InvokeVoidAsync("alert", 
                $"{solicitacoesSelecionadas.Count} solicita√ß√£o(√µes) recusada(s) com sucesso.");
            
            FecharModalRecusa();
            await CarregarSolicitacoesPendentes();
            solicitacoesSelecionadas.Clear();
            
            if (exibirTelaCobol)
            {
                VoltarParaLista();
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao recusar solicita√ß√µes: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert", $"Erro ao recusar solicita√ß√µes: {ex.Message}");
        }
    }
    private bool ExisteJustificativa()
    {
        return solicitacoesSelecionadas.Any(s => 
            !string.IsNullOrWhiteSpace(s. JustificativaAutoAlt) || 
            !string. IsNullOrWhiteSpace(s.JustificativaBelow));
    }

private async Task AlterarStatusComLog(

    

    int solicitacaoId, 
    string novoStatus, 
    string detalhes, 
    string? observacoes = null,
    string? usuario = null) // ‚úÖ ADICIONAR PAR√ÇMETRO
{
    var solicitacao = await SolicitacoesCics2025Service.ObterSolicitacaoPorIdAsync(solicitacaoId);
    if (solicitacao == null) return;

    // ‚úÖ USA O USU√ÅRIO PASSADO OU TENTA CAPTURAR
    var usuarioFinal = usuario ?? CurrentUserService.UserName;

    var statusAnterior = solicitacao.Status ?? "Pendente";
    solicitacao.Status = novoStatus;
    
    if (!string.IsNullOrWhiteSpace(observacoes))
        solicitacao.ObservacoesAdmin = observacoes;
    
    if (novoStatus == "Implementada" || novoStatus == "Rejeitada")
    {
        solicitacao.DataEfetivacao = DateTime.Now;
        solicitacao.ResponsavelEfetivacao = usuarioFinal; // ‚úÖ USA O USU√ÅRIO
    }
    
    await SolicitacoesCics2025Service.AtualizarSolicitacaoAsync(solicitacao);
    
    // ‚úÖ PASSA O USU√ÅRIO EXPLICITAMENTE
    await LogService.RegistrarAsync(
        acao: novoStatus,
        tabela: "SolicitacaoCics2025",
        registroId: solicitacaoId,
        registroIdentificador: solicitacao.NumeroSolicitacao,
        detalhes: detalhes,
        statusAnterior: statusAnterior,
        statusNovo: novoStatus,
        usuario: usuarioFinal // ‚úÖ PASSA O USU√ÅRIO
    );
}

    private string GetBadgeClassOperacao(string operacao)
    {
        return operacao switch
        {
            "DELETE" => "bg-danger",
            "ALTER" => "bg-secondary",
            "DEFINE" => "bg-dark",
            _ => "bg-secondary"
        };
    }
}